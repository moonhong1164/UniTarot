<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tarot</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:#e7ecff;
      --muted:rgba(231,236,255,.72);
      --accent:#7c3aed;
      --accent2:#38bdf8;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:radial-gradient(1200px 800px at 20% 0%, rgba(124,58,237,.35), transparent 55%),
                 radial-gradient(900px 700px at 90% 10%, rgba(56,189,248,.25), transparent 50%),
                 var(--bg);
      color:var(--text);
    }
    header{
      padding:16px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.72);
      z-index:10;
    }
    .brand{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center}
    .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2))}
    h1{margin:0;font-size:18px}
    .sub{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .tabs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .tab{
      height:32px;padding:0 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:rgba(231,236,255,.85);
      background:rgba(255,255,255,.04);
      font-size:12px;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer; user-select:none;
    }
    .tab.on{background:rgba(124,58,237,.22);border-color:rgba(124,58,237,.35)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 42px}
    .panel{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }

    .controls{
      max-width:1100px;margin:12px auto 0;
      display:grid;grid-template-columns:160px 1fr auto auto;
      gap:10px;
    }
    @media (max-width:820px){ .controls{grid-template-columns:1fr 1fr;} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field span{font-size:12px;color:var(--muted)}
    select,input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(231,236,255,.5)}
    .btn{
      padding:10px 14px;border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(135deg, rgba(124,58,237,.85), rgba(56,189,248,.55));
      color:var(--text);cursor:pointer;
      box-shadow:var(--shadow);
      height:40px;align-self:end;
    }
    .btn.ghost{background:rgba(255,255,255,.05);box-shadow:none}
    .btn:active{transform:translateY(1px)}

    .board{
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:14px;
    }
    @media (max-width:820px){ .board{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:520px){ .board{grid-template-columns:1fr;} }
    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      min-height:320px;
    }
    .cardTop{
      padding:10px 12px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .badge{font-size:12px;color:var(--muted)}
    .flipBtn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
    }
    .cardBody{
      padding:12px;
      display:flex;justify-content:center;align-items:center;
      height:calc(100% - 48px);
    }
    .card img{
      width:100%;height:100%;
      object-fit:contain;
      max-height:420px;
      filter: drop-shadow(0 14px 40px rgba(0,0,0,.45));
    }
    .cardCover{
      width:100%;height:100%;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:
        radial-gradient(600px 400px at 50% 30%, rgba(124,58,237,.35), transparent 55%),
        radial-gradient(600px 400px at 50% 80%, rgba(56,189,248,.22), transparent 55%),
        rgba(255,255,255,.03);
      display:flex;align-items:center;justify-content:center;
      color:rgba(231,236,255,.8);
      font-size:14px;
      padding:18px;text-align:center;
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(6,minmax(0,1fr));
      gap:12px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns:repeat(5,1fr);} }
    @media (max-width:920px){ .grid{grid-template-columns:repeat(4,1fr);} }
    @media (max-width:720px){ .grid{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:520px){ .grid{grid-template-columns:repeat(2,1fr);} }
    .tile{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      overflow:hidden;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .thumb{
      aspect-ratio:3/5;
      display:flex;align-items:center;justify-content:center;
      padding:10px;
    }
    .thumb img{width:100%;height:100%;object-fit:contain}
    .cap{
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px;
      font-size:12px;
      color:rgba(231,236,255,.85);
      line-height:1.35;
      min-height:44px;
    }
    .smallMuted{color:var(--muted);font-size:12px}

    .reading{
      margin-top:18px;
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .reading h2{margin:0 0 8px;font-size:16px}
    .meta{color:var(--muted);font-size:12px;margin-bottom:10px}
    .readingBody{display:grid;gap:12px}
    .readCard{
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.04);
    }
    .readCard h3{margin:0 0 6px;font-size:14px}
    .kws{color:var(--muted);font-size:12px;margin:0 0 8px}
    .readCard p{margin:6px 0;line-height:1.55;font-size:13px}
    .hidden{display:none}

    .modalBack{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modalBack.on{display:flex}
    .modal{
      width:min(980px,100%);
      max-height:min(86vh,920px);
      overflow:auto;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,16,32,.88);
      backdrop-filter:blur(10px);
      border-radius:18px;
      box-shadow:var(--shadow);
    }
    .modalHead{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead h2{margin:0;font-size:14px}
    .closeBtn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
    }
    .modalBody{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width:820px){ .modalBody{grid-template-columns:1fr;} }
    .modalImg{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:10px;
      display:flex;align-items:center;justify-content:center;
    }
    .modalImg img{width:100%;height:auto;max-height:520px;object-fit:contain}

    footer{
      border-top:1px solid var(--line);
      padding:14px 16px;
      color:rgba(231,236,255,.55);
      text-align:center;
    }
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="dot"></div>
    <div>
      <h1>Tarot</h1>
      <p class="sub">카드 뽑기 · 도감(검색) · 카드 클릭 시 해석</p>
    </div>
    <div class="tabs">
      <div id="tabDraw" class="tab on">뽑기</div>
      <div id="tabGallery" class="tab">도감</div>
      <div id="tabSettings" class="tab">이미지 경로</div>
    </div>
  </div>

  <!-- Draw controls -->
  <div id="drawControls" class="controls">
    <label class="field">
      <span>스프레드</span>
      <select id="spread">
        <option value="1">1장</option>
        <option value="3">3장 (과거·현재·미래)</option>
      </select>
    </label>

    <label class="field">
      <span>질문 (선택)</span>
      <input id="question" type="text" placeholder="예) 이번 주 흐름은?" />
    </label>

    <button id="drawBtn" class="btn">셔플 & 뽑기</button>
    <button id="resetBtn" class="btn ghost">초기화</button>
  </div>

  <!-- Gallery controls -->
  <div id="galleryControls" class="controls hidden">
    <label class="field">
      <span>검색</span>
      <input id="q" type="text" placeholder="예) 바보 / 컵 에이스 / 메이저 / 완드 ..." />
    </label>

    <label class="field">
      <span>폴더</span>
      <select id="folder">
        <option value="all">전체</option>
      </select>
    </label>

    <label class="field">
      <span>정렬</span>
      <select id="sort">
        <option value="name">이름순</option>
        <option value="folder">폴더→이름</option>
      </select>
    </label>

    <div class="smallMuted" id="count"></div>
  </div>
</header>

<main class="wrap">
  <!-- DRAW VIEW -->
  <section id="drawView">
    <section class="panel">
      <p style="margin:6px 0">
        <b>카드 목록</b>: <code>data/cards.json</code><br/>
        <b>해석</b>: <code>data/interpretations.json</code> (있으면 카드 클릭 시 표시)<br/>
        <b>이미지</b>: 폴더/파일명은 그대로 올리고, 경로는 이 페이지가 자동으로 찾아요.
      </p>
      <p class="smallMuted" style="margin:6px 0">
        이미지가 안 뜨면 상단 <b>이미지 경로</b> 탭에서 “내가 올린 폴더”를 한 번만 지정하면 끝.
      </p>
    </section>

    <section id="board" class="board" aria-live="polite"></section>

    <section id="reading" class="reading hidden">
      <h2>리딩</h2>
      <div id="readingMeta" class="meta"></div>
      <div id="readingBody" class="readingBody"></div>
    </section>
  </section>

  <!-- GALLERY VIEW -->
  <section id="galleryView" class="hidden">
    <section class="panel">
      <p style="margin:6px 0">카드를 클릭하면 큰 이미지 + 해석(있으면)이 떠요.</p>
    </section>

    <section id="grid" class="grid" aria-live="polite"></section>
  </section>

  <!-- SETTINGS VIEW -->
  <section id="settingsView" class="hidden">
    <section class="panel">
      <h2 style="margin:0 0 10px;font-size:16px">이미지 경로 설정</h2>
      <p class="smallMuted" style="margin:6px 0 12px">
        카드는 <code>cards.json</code>에 “폴더/파일명”만 들어있고,<br/>
        실제 이미지가 저장된 “상위 폴더(루트)”는 여기서 지정하면 어디에 올려도 동작해요.
      </p>

      <label class="field" style="max-width:520px">
        <span>내 이미지 루트 경로 (예: assets/cards 또는 images 또는 .)</span>
        <input id="imgRootInput" placeholder="assets/cards" />
      </label>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="saveRootBtn" class="btn" style="height:auto">저장</button>
        <button id="resetRootBtn" class="btn ghost" style="height:auto">자동탐색으로 되돌리기</button>
      </div>

      <p class="smallMuted" style="margin-top:12px">
        * 저장하면 브라우저에 기억돼요(로컬스토리지). 다른 사람에게는 영향 없음.
      </p>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

      <p class="smallMuted" style="margin:0">
        <b>자동탐색 후보</b>: <span id="rootsPreview"></span>
      </p>
    </section>
  </section>
</main>

<!-- MODAL -->
<div id="modalBack" class="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modalHead">
      <h2 id="modalTitle">카드</h2>
      <button class="closeBtn" id="closeBtn">닫기</button>
    </div>
    <div class="modalBody">
      <div class="modalImg"><img id="modalImg" alt="" /></div>
      <div class="modalText" id="modalText"></div>
    </div>
  </div>
</div>

<footer>made for GitHub Pages</footer>

<script>
  // ======================
  // 1) 이미지 루트 후보들
  // ======================
  // cards.json의 img는 "메이저/0. 바보 카드.jpg" 같은 '상대경로'만 들어있다고 가정하고,
  // 아래 후보 루트들 + img를 이어붙여서 실제 이미지를 찾습니다.
  const DEFAULT_IMAGE_ROOTS = [
    "assets/cards",   // 추천
    "assets",         // 혹시 assets/메이저/... 형태
    "cards",          // cards/메이저/...
    "images",         // images/메이저/...
    ".",              // 루트에 메이저/...
  ];

  const ROOT_KEY = "tarot_image_root"; // 사용자 지정 루트 저장 키

  const state = {
    cards: [],
    meanings: null,
    drawn: [],
    revealed: new Set(),
    imageRoot: null, // user override or null
  };

  const $ = (sel) => document.querySelector(sel);

  // ----------------------
  // Utils
  // ----------------------
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }
  function norm(s){ return (s||'').toLowerCase().replace(/\s+/g,''); }
  function positionLabel(i, spreadN){
    if(spreadN === 3) return ["과거","현재","미래"][i] || `CARD ${i+1}`;
    if(spreadN === 1) return "오늘의 카드";
    return `CARD ${i+1}`;
  }
  function folderOf(card){
    // img: "메이저/0. 바보 카드.jpg" -> "메이저"
    const parts = (card.img || '').split('/');
    return parts[0] || '기타';
  }
  function meaningFor(title){
    if(!state.meanings) return null;
    const exact = state.meanings.find(x => x.title === title);
    if(exact) return exact;
    // 공백 제거 느슨매칭
    return state.meanings.find(x => norm(x.title) === norm(title)) || null;
  }

  function getRoots(){
    const override = state.imageRoot;
    if(override) return [override];
    // 자동탐색 후보
    return DEFAULT_IMAGE_ROOTS.slice();
  }
  function joinPath(root, rel){
    // root="", ".", "assets/cards" 등 처리
    root = (root || "").replace(/\/+$/,'');      // 뒤 / 제거
    rel  = (rel  || "").replace(/^\/+/,'');      // 앞 / 제거
    if(root === "." || root === "") return rel;
    return root + "/" + rel;
  }

  // rel(img) 기준으로 실제 로드 가능한 src 찾기 (여러 루트 후보를 시도)
  async function resolveImageSrc(rel){
    const roots = getRoots();
    for(const r of roots){
      const candidate = joinPath(r, rel);
      const ok = await probeImage(candidate);
      if(ok) return candidate;
    }
    // 끝까지 실패하면 첫 후보라도 반환 (깨진 이미지라도 alt로 표시)
    return joinPath(roots[0] || ".", rel);
  }

  // 이미지가 실제로 로드되는지 확인
  function probeImage(src){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>resolve(true);
      img.onerror = ()=>resolve(false);
      img.src = src + (src.includes("?") ? "&" : "?") + "v=" + Date.now(); // 캐시 회피
    });
  }

  // ----------------------
  // Data load
  // ----------------------
  async function loadData(){
    // user override root
    const saved = localStorage.getItem(ROOT_KEY);
    state.imageRoot = saved && saved.trim() ? saved.trim() : null;

    // 카드 목록
    const cardsRes = await fetch('data/cards.json');
    const rawCards = await cardsRes.json();

    // images: src 자동해결을 위해 각 카드에 resolvedSrc를 붙임
    state.cards = [];
    for(const c of rawCards){
      const resolvedSrc = await resolveImageSrc(c.img);
      state.cards.push({ ...c, resolvedSrc });
    }

    // 해석(선택)
    try{
      const mRes = await fetch('data/interpretations.json', { cache:'no-store' });
      state.meanings = await mRes.json();
    }catch(e){
      state.meanings = null;
    }

    // 폴더 셀렉트 구성
    const folders = Array.from(new Set(state.cards.map(folderOf))).sort((a,b)=>a.localeCompare(b,'ko'));
    const sel = $('#folder');
    folders.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f;
      opt.textContent = f;
      sel.appendChild(opt);
    });

    // settings UI
    $('#imgRootInput').value = state.imageRoot || "";
    $('#rootsPreview').textContent = getRoots().join(" , ");
  }

  // ----------------------
  // Draw view
  // ----------------------
  function renderBoard(){
    const board = $('#board');
    board.innerHTML = '';
    const spreadN = Number($('#spread').value);

    for(let i=0;i<spreadN;i++){
      const slot = state.drawn[i];
      const revealed = state.revealed.has(i);

      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="cardTop">
          <div class="badge">${positionLabel(i, spreadN)}</div>
          <button class="flipBtn" data-idx="${i}">${revealed ? '가리기' : '공개'}</button>
        </div>
        <div class="cardBody">
          ${revealed && slot
            ? `<img src="${slot.resolvedSrc}" alt="${slot.title}">`
            : `<div class="cardCover">셔플 후 <b>공개</b> 버튼을 눌러 카드를 확인해요.</div>`}
        </div>
      `;
      board.appendChild(el);
    }

    board.querySelectorAll('.flipBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = Number(btn.dataset.idx);
        if(state.revealed.has(idx)) state.revealed.delete(idx);
        else state.revealed.add(idx);
        renderBoard();
        renderReading();
      });
    });

    // 카드 이미지 클릭하면 해석 모달도 뜨게(공개된 카드만)
    board.querySelectorAll('img').forEach((imgEl, k)=>{
      imgEl.style.cursor = "pointer";
      imgEl.addEventListener('click', ()=>{
        // 공개된 카드 중 몇 번째인지 찾아서 openModal
        const card = state.drawn.find(c => c && c.resolvedSrc === imgEl.getAttribute('src'));
        if(card) openModal(card);
      });
    });
  }

  function renderReading(){
    const reading = $('#reading');
    const body = $('#readingBody');
    const meta = $('#readingMeta');

    const revealedIdxs = [...state.revealed].sort((a,b)=>a-b);
    if(revealedIdxs.length === 0){
      reading.classList.add('hidden');
      return;
    }
    reading.classList.remove('hidden');

    const q = ($('#question').value || '').trim();
    const spreadN = Number($('#spread').value);
    meta.textContent = [
      q ? `질문: ${q}` : '질문: (없음)',
      `스프레드: ${spreadN}장`,
      state.meanings ? '해석: 로드됨' : '해석: 없음(이미지 뽑기만)'
    ].join(' · ');

    body.innerHTML = '';
    for(const idx of revealedIdxs){
      const c = state.drawn[idx];
      if(!c) continue;

      const m = meaningFor(c.title);
      const kws = m?.keywords?.length ? m.keywords.join(', ') : null;

      const block = document.createElement('div');
      block.className = 'readCard';
      block.innerHTML = `
        <h3>${positionLabel(idx, spreadN)} · <span style="text-decoration:underline; cursor:pointer" data-open="${c.title}">${c.title}</span></h3>
        ${kws ? `<p class="kws"><b>키워드</b> · ${kws}</p>` : ''}
        ${m?.love ? `<p><b>애정운</b> · ${m.love}</p>` : ''}
        ${m?.money ? `<p><b>금전운</b> · ${m.money}</p>` : ''}
        ${m?.career ? `<p><b>학업/직업/사업</b> · ${m.career}</p>` : ''}
        ${(!m && state.meanings) ? `<p class="smallMuted">해석 매칭 실패: interpretations.json의 title과 cards.json의 title이 동일한지 확인!</p>` : ''}
      `;
      body.appendChild(block);
    }

    // 제목 클릭 시 모달
    body.querySelectorAll('[data-open]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const t = el.getAttribute('data-open');
        const card = state.cards.find(c=>c.title===t);
        if(card) openModal(card);
      });
    });
  }

  function doDraw(){
    const spreadN = Number($('#spread').value);
    const deck = shuffle(state.cards);
    state.drawn = deck.slice(0, spreadN);
    state.revealed = new Set();
    renderBoard();
    renderReading();
  }

  function doReset(){
    state.drawn = [];
    state.revealed = new Set();
    $('#question').value = '';
    renderBoard();
    renderReading();
  }

  // ----------------------
  // Gallery view
  // ----------------------
  function sortCards(list, mode){
    const copy = list.slice();
    if(mode === 'folder'){
      copy.sort((a,b)=>{
        const fa = folderOf(a), fb = folderOf(b);
        if(fa !== fb) return fa.localeCompare(fb, 'ko');
        return (a.title||'').localeCompare((b.title||''), 'ko');
      });
    }else{
      copy.sort((a,b)=> (a.title||'').localeCompare((b.title||''), 'ko'));
    }
    return copy;
  }

  function renderGallery(){
    const q = norm($('#q').value);
    const folder = $('#folder').value;
    const sort = $('#sort').value;

    let list = state.cards.slice();
    if(folder !== 'all') list = list.filter(c => folderOf(c) === folder);
    if(q) list = list.filter(c => norm(c.title).includes(q) || norm(folderOf(c)).includes(q));
    list = sortCards(list, sort);

    $('#count').textContent = `${list.length} / ${state.cards.length} 장`;

    const grid = $('#grid');
    grid.innerHTML = '';
    for(const c of list){
      const el = document.createElement('article');
      el.className = 'tile';
      el.innerHTML = `
        <div class="thumb"><img src="${c.resolvedSrc}" alt="${c.title}"></div>
        <div class="cap"><b>${c.title}</b><div class="smallMuted">${folderOf(c)}</div></div>
      `;
      el.addEventListener('click', ()=>openModal(c));
      grid.appendChild(el);
    }
  }

  // ----------------------
  // Modal (카드 클릭 → 해석)
  // ----------------------
  function openModal(card){
    const back = $('#modalBack');
    $('#modalTitle').textContent = card.title;
    $('#modalImg').src = card.resolvedSrc;
    $('#modalImg').alt = card.title;

    const m = meaningFor(card.title);
    const kws = m?.keywords?.length ? m.keywords.join(', ') : null;

    $('#modalText').innerHTML = `
      <p class="kws"><b>폴더</b> · ${folderOf(card)}</p>
      ${kws ? `<p class="kws"><b>키워드</b> · ${kws}</p>` : ''}
      ${m?.love ? `<p><b>애정운</b> · ${m.love}</p>` : ''}
      ${m?.money ? `<p><b>금전운</b> · ${m.money}</p>` : ''}
      ${m?.career ? `<p><b>학업/직업/사업</b> · ${m.career}</p>` : ''}
      ${(!m && state.meanings) ? `<p class="smallMuted">해석 매칭 실패: interpretations.json의 title과 cards.json의 title이 동일한지 확인!</p>` : ''}
      ${(!state.meanings) ? `<p class="smallMuted">해석 데이터가 없어서 이미지 도감만 표시 중이에요.</p>` : ''}
    `;

    back.classList.add('on');
    back.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    const back = $('#modalBack');
    back.classList.remove('on');
    back.setAttribute('aria-hidden','true');
  }

  // ----------------------
  // Tabs + Settings
  // ----------------------
  function show(view){
    const isDraw = view === 'draw';
    const isGallery = view === 'gallery';
    const isSettings = view === 'settings';

    $('#tabDraw').classList.toggle('on', isDraw);
    $('#tabGallery').classList.toggle('on', isGallery);
    $('#tabSettings').classList.toggle('on', isSettings);

    $('#drawControls').classList.toggle('hidden', !isDraw);
    $('#galleryControls').classList.toggle('hidden', !isGallery);

    $('#drawView').classList.toggle('hidden', !isDraw);
    $('#galleryView').classList.toggle('hidden', !isGallery);
    $('#settingsView').classList.toggle('hidden', !isSettings);

    if(isGallery) renderGallery();
  }

  async function applyNewRoot(newRoot){
    state.imageRoot = newRoot && newRoot.trim() ? newRoot.trim() : null;
    if(state.imageRoot) localStorage.setItem(ROOT_KEY, state.imageRoot);
    else localStorage.removeItem(ROOT_KEY);

    // 이미지 src 재해결
    const rawCardsRes = await fetch('data/cards.json', { cache:'no-store' });
    const rawCards = await rawCardsRes.json();
    state.cards = [];
    for(const c of rawCards){
      const resolvedSrc = await resolveImageSrc(c.img);
      state.cards.push({ ...c, resolvedSrc });
    }

    // 폴더 select 다시 구성
    const sel = $('#folder');
    sel.innerHTML = `<option value="all">전체</option>`;
    const folders = Array.from(new Set(state.cards.map(folderOf))).sort((a,b)=>a.localeCompare(b,'ko'));
    folders.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f;
      opt.textContent = f;
      sel.appendChild(opt);
    });

    $('#rootsPreview').textContent = getRoots().join(" , ");

    // 화면 갱신
    doReset();
    renderGallery();
  }

  // ----------------------
  // Init
  // ----------------------
  (async function init(){
    await loadData();

    renderBoard();
    renderReading();

    $('#drawBtn').addEventListener('click', doDraw);
    $('#resetBtn').addEventListener('click', doReset);
    $('#spread').addEventListener('change', ()=>{ doReset(); });

    ['q','folder','sort'].forEach(id=>{
      $('#'+id).addEventListener('input', renderGallery);
      $('#'+id).addEventListener('change', renderGallery);
    });

    $('#tabDraw').addEventListener('click', ()=>show('draw'));
    $('#tabGallery').addEventListener('click', ()=>show('gallery'));
    $('#tabSettings').addEventListener('click', ()=>show('settings'));

    $('#saveRootBtn').addEventListener('click', async ()=>{
      const v = $('#imgRootInput').value;
      await applyNewRoot(v);
      show('draw');
      alert("이미지 경로 저장 완료! 카드가 잘 뜨는지 확인해줘.");
    });

    $('#resetRootBtn').addEventListener('click', async ()=>{
      $('#imgRootInput').value = "";
      await applyNewRoot("");
      alert("자동탐색으로 되돌렸어.");
    });

    $('#closeBtn').addEventListener('click', closeModal);
    $('#modalBack').addEventListener('click', (e)=>{ if(e.target.id==='modalBack') closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    show('draw');
  })();
</script>
</body>
</html>
