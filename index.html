<!DOCTYPE html>
<html lang="ko"><head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UniTarot</title>
<style>
:root{--bg1:#fff7f1;--bg2:#f3f7ff;--line:#e7dcd3;--text:#2b2430;--muted:#6e6476;--accent:#ff8fab;--accent2:#7aa2ff;--shadow:0 18px 50px rgba(48,24,54,.10);--radius:18px;}
*{box-sizing:border-box}
body{margin:0;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:
radial-gradient(900px 700px at 20% 0%, rgba(255,143,171,.25), transparent 55%),
radial-gradient(900px 700px at 90% 10%, rgba(122,162,255,.18), transparent 55%),
linear-gradient(180deg,var(--bg1),var(--bg2));min-height:100vh;}
header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,0,0,.06);padding:14px 16px;}
.brand{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center}
.dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2))}
h1{margin:0;font-size:18px}
.sub{margin:2px 0 0;font-size:12px;color:var(--muted)}
.tabs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.tab{height:32px;padding:0 12px;border-radius:999px;cursor:pointer;user-select:none;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.75);color:rgba(43,36,48,.9);font-size:12px;display:inline-flex;align-items:center;justify-content:center;}
.tab.on{background:rgba(255,143,171,.20);border-color:rgba(255,143,171,.35)}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 42px}
.controls{max-width:1100px;margin:10px auto 0;display:grid;gap:10px;grid-template-columns:1fr auto auto auto auto;align-items:end;}
@media (max-width:980px){.controls{grid-template-columns:1fr 1fr;}}
.field{display:flex;flex-direction:column;gap:6px}
.field span{font-size:12px;color:var(--muted)}
input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.9);color:var(--text);outline:none;}
input::placeholder{color:rgba(110,100,118,.7)}
.btn{padding:10px 14px;border-radius:12px;cursor:pointer;border:1px solid rgba(0,0,0,.10);background:linear-gradient(135deg, rgba(255,143,171,.95), rgba(122,162,255,.55));color:#231b2a;font-weight:700;box-shadow:var(--shadow);height:40px;white-space:nowrap;}
.btn.ghost{background:rgba(255,255,255,.9);font-weight:600}
.btn:active{transform:translateY(1px)}
.hidden{display:none}
.spreadBar{max-width:1100px;margin:10px auto 0;display:flex;gap:8px;flex-wrap:wrap;}
.pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.10);background:rgba(255,255,255,.85);cursor:pointer;font-size:12px;color:rgba(43,36,48,.88);user-select:none;}
.pill.on{background:rgba(122,162,255,.16);border-color:rgba(122,162,255,.40)}
.board{margin-top:14px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
@media (max-width:820px){.board{grid-template-columns:repeat(2,1fr);}}
@media (max-width:520px){.board{grid-template-columns:1fr;}}

/* âœ… ì–‘ìíƒì¼(A or B) ì „ìš© ë°°ì—´: 5ì¥ */
/* â–¶ ì–‘ìíƒì¼ ê°€ë¡œ 1ì¤„ ë°°ì—´ (ë°ìŠ¤í¬í†±) */
.board.choice{
  grid-template-columns:repeat(5,minmax(0,1fr));
  grid-template-areas:"aRes aSel cur bSel bRes";
}
/* ëª¨ë°”ì¼ì€ 2ì¤„ */
@media (max-width:820px){
  .board.choice{
    grid-template-columns:repeat(2,minmax(0,1fr));
    grid-template-areas:
      "cur cur"
      "aSel bSel"
      "aRes bRes";
  }
}

.card{border:1px solid rgba(0,0,0,.06);background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,250,246,.92));border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);min-height:280px}
.cardTop{padding:10px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.70)}
.badge{font-size:12px;color:var(--muted)}
.flipBtn{border:1px solid rgba(0,0,0,.10);background:rgba(255,255,255,.85);color:var(--text);border-radius:999px;padding:7px 10px;cursor:pointer;}
.cardBody{padding:10px;display:flex;justify-content:center;align-items:center;height:calc(100% - 48px)}
.card img{width:100%;height:100%;object-fit:contain;max-height:360px;filter:drop-shadow(0 14px 32px rgba(48,24,54,.16))}
.cardCover{width:100%;height:100%;border-radius:14px;border:1px dashed rgba(0,0,0,.12);background:
radial-gradient(600px 400px at 50% 30%, rgba(255,143,171,.18), transparent 55%),
radial-gradient(600px 400px at 50% 80%, rgba(122,162,255,.12), transparent 55%),
rgba(255,255,255,.75);display:flex;align-items:center;justify-content:center;color:rgba(43,36,48,.82);font-size:14px;padding:18px;text-align:center;}
.reading{margin-top:18px;border:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.92);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.reading h2{margin:0 0 8px;font-size:16px}
.meta{color:var(--muted);font-size:12px;margin-bottom:10px}
.readingBody{display:grid;gap:12px}
.readCard{border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px;background:rgba(255,250,246,.85)}
.readCard h3{margin:0 0 6px;font-size:14px}
.kws{color:var(--muted);font-size:12px;margin:0 0 8px}
.bullets{margin:6px 0 0;padding-left:18px;}
.bullets li{margin:6px 0;line-height:1.6;font-size:13px}
.sectionTitle{margin:10px 0 6px;font-size:13px;color:rgba(43,36,48,.92);}
.grid{margin-top:14px;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
@media (max-width:1100px){.grid{grid-template-columns:repeat(5,1fr);}}
@media (max-width:920px){.grid{grid-template-columns:repeat(4,1fr);}}
@media (max-width:720px){.grid{grid-template-columns:repeat(3,1fr);}}
@media (max-width:520px){.grid{grid-template-columns:repeat(2,1fr);}}
.tile{border:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.90);border-radius:16px;overflow:hidden;cursor:pointer;box-shadow:var(--shadow)}
.thumb{aspect-ratio:3/5;display:flex;align-items:center;justify-content:center;padding:10px}
.thumb img{width:100%;height:100%;object-fit:contain}
.cap{border-top:1px solid rgba(0,0,0,.06);padding:10px;font-size:12px;color:rgba(43,36,48,.92);line-height:1.35;min-height:44px}
.smallMuted{color:var(--muted);font-size:12px}
.listWrap{margin-top:14px;display:grid;gap:10px}
.row{border:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.92);border-radius:16px;box-shadow:var(--shadow);padding:12px}
.rowHead{display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}
.rowTitle{font-weight:800}
.rowBtns{display:flex;gap:8px;flex-wrap:wrap}
.miniBtn{border:1px solid rgba(0,0,0,.10);background:rgba(255,255,255,.85);color:var(--text);border-radius:999px;padding:7px 10px;cursor:pointer;font-size:12px;}
.miniBtn.danger{border-color:rgba(255,0,0,.25);}
.modalBack{position:fixed;inset:0;background:rgba(34,25,44,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modalBack.on{display:flex}
.modal{width:min(980px,100%);max-height:min(86vh,920px);overflow:auto;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border-radius:18px;box-shadow:var(--shadow)}
.modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.06)}
.modalHead h2{margin:0;font-size:14px}
.closeBtn{border:1px solid rgba(0,0,0,.10);background:rgba(255,255,255,.85);color:var(--text);border-radius:999px;padding:7px 10px;cursor:pointer}
.modalBody{display:grid;grid-template-columns:320px 1fr;gap:14px;padding:14px}
@media (max-width:820px){.modalBody{grid-template-columns:1fr;}}
.modalImg{border:1px solid rgba(0,0,0,.06);border-radius:16px;background:rgba(255,250,246,.75);padding:10px;display:flex;align-items:center;justify-content:center}
.modalImg img{width:100%;height:auto;max-height:520px;object-fit:contain}
.rawBox{margin-top:10px;white-space:pre-wrap;line-height:1.6;font-size:12px;color:rgba(43,36,48,.88);border:1px solid rgba(0,0,0,.06);border-radius:14px;background:rgba(255,250,246,.75);padding:10px;}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(255,255,255,.92);border:1px solid rgba(0,0,0,.10);box-shadow:var(--shadow);border-radius:999px;padding:10px 14px;font-size:12px;display:none;z-index:100;}
.toast.on{display:block}

/* ğŸ”½ ì–‘ìíƒì¼ ì¹´ë“œ í¬ê¸° ì¶•ì†Œ */
.board.choice .card{
  min-height:220px;
}
.board.choice .cardBody{
  height:200px;
  padding:8px;
}
.board.choice img{
  max-height:220px;
}
@media (max-width:820px){
  .board.choice .card{
    min-height:200px;
  }
  .board.choice img{
    max-height:200px;
  }
}


/* âœ¨ ì–‘ìíƒì¼ ê°•ì¡° ìŠ¤íƒ€ì¼ */
.board.choice .card{ transition: transform .15s ease; }
.board.choice .cardTop{ position:relative; }

/* A(í•‘í¬) / B(ë¸”ë£¨) í¬ì¸íŠ¸ */
.board.choice .card[data-area="aRes"] .cardTop,
.board.choice .card[data-area="aSel"] .cardTop{
  background: rgba(255,143,171,.22);
  border-bottom-color: rgba(255,143,171,.35);
}
.board.choice .card[data-area="bRes"] .cardTop,
.board.choice .card[data-area="bSel"] .cardTop{
  background: rgba(122,162,255,.20);
  border-bottom-color: rgba(122,162,255,.35);
}

/* í˜„ì¬ìƒí™© ì¹´ë“œ ê°•ì¡° */
.board.choice .card[data-area="cur"]{
  border:2px solid rgba(255,143,171,.38);
  box-shadow: 0 18px 44px rgba(48,24,54,.14);
  transform: scale(1.02);
}
.board.choice .card[data-area="cur"] .cardTop{
  background: linear-gradient(135deg, rgba(255,143,171,.22), rgba(122,162,255,.14));
  border-bottom-color: rgba(0,0,0,.08);
}
.board.choice .card[data-area="cur"] .badge{
  font-weight:900;
  color: rgba(43,36,48,.95);
}

/* ì–‘ìíƒì¼ ì „ìš© ì•ˆë‚´ë¬¸ */
.choiceNote{
  margin-top:12px;
  border:1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.86);
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 12px 14px;
  display:none;
}
.choiceNote.on{ display:block; }
.choiceNote .title{ font-weight:900; margin:0 0 6px; font-size:13px; }
.choiceNote .txt{ margin:0; color: var(--muted); font-size:12px; line-height:1.6; }
.choiceNote b{ color: rgba(43,36,48,.92); }


/* ğŸ§© ì–‘ìíƒì¼ 'ê°€ë¡œ' ì´ˆì»´íŒ©íŠ¸ ëª¨ë“œ */
.board.choice{ gap:10px; margin-top:10px; }
.board.choice .card{ min-height:180px; }
.board.choice .cardTop{ padding:8px 10px; }
.board.choice .badge{ font-size:11px; }
.board.choice .flipBtn{ padding:6px 9px; font-size:11px; }
.board.choice .cardBody{ height:150px; padding:6px; }
.board.choice img{ max-height:160px; }

/* í˜„ì¬ìƒí™© ê°•ì¡°ëŠ” ìœ ì§€í•˜ë˜ ê³¼í•˜ì§€ ì•Šê²Œ */
.board.choice .card[data-area="cur"]{ transform: scale(1.02); border-width:2px; }

/* ì•ˆë‚´ë¬¸ ë” ì‘ê²Œ + ì ‘ê¸° ê°€ëŠ¥í•˜ê²Œ */
.choiceNote{ padding:10px 12px; }
.choiceNote .title{ font-size:12px; margin:0; }
.choiceNote .txt{ font-size:11px; margin:6px 0 0; }
.choiceNote details{ margin-top:4px; }
.choiceNote summary{ cursor:pointer; color: rgba(43,36,48,.86); }


/* âœ… ê³µê°œ/ê°€ë¦¬ê¸° ë²„íŠ¼ ì œê±° */
.flipBtn{ display:none !important; }

/* âœ… ì¹´ë“œ í¬ê¸°(ì „ì²´) ì‚´ì§ ì¶•ì†Œ + í†µì¼ */
.card{ min-height:280px; }
.cardBody{ padding:10px; }
.card img{ max-height:360px; }

/* âœ… ê¸´ ìŠ¤í”„ë ˆë“œ(6/7 ë“±) ê°€ë¡œ ìŠ¤í¬ë¡¤ */
.board.hscroll{
  grid-template-columns:none !important;
  grid-auto-flow:column;
  grid-auto-columns:minmax(170px, 1fr);
  overflow-x:auto;
  padding-bottom:6px;
  scroll-snap-type:x mandatory;
}
.board.hscroll .card{ scroll-snap-align:start; }

/* ëª¨ë°”ì¼ì—ì„  ë” ì´˜ì´˜í•˜ê²Œ */
@media (max-width:820px){
  .board.hscroll{ grid-auto-columns:minmax(155px, 1fr); }
}


/* ğŸ”» ì–‘ìíƒì¼ ì¹´ë“œ ë°•ìŠ¤ ë” ì¶•ì†Œ(ê°€ë¡œ 1ì¤„ ë§ì¶¤) */
.board.choice{ gap:8px; }
.board.choice .card{ min-height:150px; }
.board.choice .cardBody{ height:120px; padding:6px; }
.board.choice img{ max-height:140px; }
.board.choice .cardTop{ padding:7px 9px; }
.board.choice .badge{ font-size:11px; }
@media (max-width:820px){
  .board.choice .card{ min-height:160px; }
  .board.choice img{ max-height:160px; }
}


/* ğŸ”½ ì¹´ë“œ í¬ê¸° ì „ì²´ ì¶”ê°€ ì¶•ì†Œ */
.card{ min-height:240px; }
.cardBody{ padding:8px; }
.card img{ max-height:300px; }

/* ğŸ”½ ì–‘ìíƒì¼ì€ ë” ì‘ê²Œ */
.board.choice .card{ min-height:130px; }
.board.choice .cardBody{ height:100px; padding:5px; }
.board.choice img{ max-height:120px; }
.board.choice .cardTop{ padding:6px 8px; }
.board.choice .badge{ font-size:10.5px; }


/* ğŸ–¼ï¸ ì¹´ë“œê°€ ë°•ìŠ¤ ì•ˆì— 'ë”±' ë§ê²Œ: ê³ ì • ë¹„ìœ¨ í”„ë ˆì„ */
:root{
  --card-ratio: 3 / 5;          /* ë ˆë…¸ë¨¼ë“œ/íƒ€ë¡œ ë¹„ìŠ·í•œ ì„¸ë¡œ ë¹„ìœ¨ */
  --img-fit: contain;           /* contain=ì•ˆ ì˜ë¦¼(ì—¬ë°± ìµœì†Œ), cover=ì—¬ë°± 0ì— ê°€ê¹ì§€ë§Œ ê°€ì¥ìë¦¬ ì˜ë¦´ ìˆ˜ ìˆìŒ */
}
.cardBody{
  padding:6px;
  height:auto !important;       /* ê³ ì • ë†’ì´ ëŒ€ì‹  í”„ë ˆì„ ë¹„ìœ¨ë¡œ */
  align-items:stretch;
}
.cardFrame{
  width:100%;
  aspect-ratio: var(--card-ratio);
  position:relative;
  overflow:hidden;
  border-radius:14px;
  background: rgba(255,255,255,.55);
  border: 1px solid rgba(0,0,0,.06);
}
.cardFrame img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit: var(--img-fit);
  object-position:center;
}

/* ì–‘ìíƒì¼/ê°€ë¡œ ìŠ¤í”„ë ˆë“œì—ì„œë„ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
.board.choice .cardBody{ padding:5px; }
.board.hscroll .cardBody{ padding:6px; }


/* âœ… í”„ë ˆì„ì€ ìœ ì§€í•˜ë˜, 'ë°•ìŠ¤ê°€ ì»¤ ë³´ì´ëŠ”' ì›ì¸(ì»¬ëŸ¼ í­/í”„ë ˆì„ í­)ì„ ì¤„ì´ê¸° */
.board{ gap:12px; } /* ê¸°ë³¸ ê°„ê²© ì•½ê°„ ì¶•ì†Œ */

/* ì¹´ë“œ ìì²´ ë†’ì´ ê³ ì • ì œê±°(í”„ë ˆì„ì´ ë†’ì´ë¥¼ ê²°ì •) */
.card{ min-height:unset !important; }

/* í”„ë ˆì„ í­ì„ ì œí•œí•´ì„œ 'ë„ˆë¬´ ë„“ì–´ì§€ëŠ”' ëŠë‚Œ ë°©ì§€ */
.cardBody{ display:flex; justify-content:center; align-items:stretch; padding:6px; }
.cardFrame{ width:min(100%, 210px); }  /* ë°ìŠ¤í¬í†±ì—ì„œ í•œ ì¹´ë“œ ìµœëŒ€ í­ */

/* ê¸´ ìŠ¤í”„ë ˆë“œëŠ” ê°€ë¡œ ì¹´ë“œí­ì„ ì¡°ê¸ˆ ë” íƒ€ì´íŠ¸í•˜ê²Œ */
.board.hscroll{ grid-auto-columns:minmax(150px, 1fr); }

/* ì–‘ìíƒì¼ì€ ë” ì‘ê²Œ */
.board.choice .cardFrame{ width:min(100%, 170px); }
@media (max-width:820px){
  .cardFrame{ width:min(100%, 190px); }
  .board.choice .cardFrame{ width:min(100%, 160px); }
  .board.hscroll{ grid-auto-columns:minmax(140px, 1fr); }
}


/* ğŸ“ í•´ì„ í‘œì‹œ ë°©ì‹ ê°œì„ : ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜ + ì¤„ê¸€ */
.readCard .section{
  display:flex;
  gap:10px;
  align-items:flex-start;
  margin:8px 0;
}
.readCard .ico{
  flex:0 0 auto;
  width:26px;
  height:26px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  background: rgba(122,162,255,.18);
}
.readCard .txt{
  font-size:13px;
  line-height:1.65;
}

</style></head>
<body>
<header>
  <div class="brand">
    <div class="dot"></div>
    <div><h1>UniTarot</h1><p class="sub" id="status">ë¡œë”© ì¤‘â€¦</p></div>
    <div class="tabs">
      <div id="tabDraw" class="tab on">ë½‘ê¸°</div>
      <div id="tabGallery" class="tab">ë„ê°</div>
      <div id="tabDict" class="tab">ì‚¬ì „</div>
      <div id="tabSaved" class="tab">ì €ì¥í•¨</div>
    </div>
  </div>

  <div class="spreadBar" id="spreadBar"></div>

  <div id="drawControls" class="controls">
    <label class="field"><span>ì§ˆë¬¸ (ì„ íƒ)</span><input id="question" placeholder="ì˜ˆ) ì´ë²ˆ ì£¼ íë¦„ì€?" /></label>
    <button id="drawBtn" class="btn">ì…”í”Œ & ë½‘ê¸°</button>
    <button id="shareBtn" class="btn ghost">ê³µìœ  ë§í¬</button>
    <button id="saveBtn" class="btn ghost">ê²°ê³¼ ì €ì¥</button>
    <button id="resetBtn" class="btn ghost">ì´ˆê¸°í™”</button>
  </div>

  <div id="galleryControls" class="controls hidden">
    <label class="field"><span>ê²€ìƒ‰</span><input id="q" placeholder="ì˜ˆ) ë°”ë³´ / ì»µ ì—ì´ìŠ¤ / ì†Œë“œ10 ..." /></label>
    <label class="field"><span>í´ë”</span><input id="folderSearch" placeholder="ì˜ˆ) ë©”ì´ì € / ì™„ë“œ / ì»µ ..." /></label>
    <div class="smallMuted" id="count"></div>
    <div></div><div></div>
  </div>

  <div id="dictControls" class="controls hidden">
    <label class="field"><span>í•´ì„ ì‚¬ì „ ê²€ìƒ‰</span><input id="dq" placeholder="ì˜ˆ) ë°”ë³´ / ë§ˆë²•ì‚¬ / ì»µ ì—ì´ìŠ¤ ..." /></label>
    <label class="field"><span>í‚¤ì›Œë“œ ê²€ìƒ‰(ì„ íƒ)</span><input id="dkw" placeholder="ì˜ˆ) ì„±ì¥, ê¸°íšŒ, ì„ íƒ..." /></label>
    <div class="smallMuted" id="dcount"></div>
    <div></div><div></div>
  </div>

  <div id="savedControls" class="controls hidden">
    <label class="field"><span>ì €ì¥í•¨ ê²€ìƒ‰</span><input id="sq" placeholder="ì§ˆë¬¸/ì¹´ë“œëª…ìœ¼ë¡œ ê²€ìƒ‰" /></label>
    <button id="clearSavedBtn" class="btn ghost">ì „ì²´ ì‚­ì œ</button>
    <div class="smallMuted" id="scount"></div>
    <div></div><div></div>
  </div>
</header>

<main class="wrap">
  <section id="drawView">
    
    <div id="choiceNote" class="choiceNote" aria-live="polite"></div>
<section id="board" class="board" aria-live="polite"></section>
    <section id="reading" class="reading hidden">
      <h2>ë¦¬ë”©</h2>
      <div id="readingMeta" class="meta"></div>
      <div id="readingBody" class="readingBody"></div>
    </section>
  </section>

  <section id="galleryView" class="hidden">
    <section id="grid" class="grid" aria-live="polite"></section>
  </section>

  <section id="dictView" class="hidden">
    <section id="dictList" class="listWrap" aria-live="polite"></section>
  </section>

  <section id="savedView" class="hidden">
    <section id="savedList" class="listWrap" aria-live="polite"></section>
  </section>
</main>

<div id="modalBack" class="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modalHead"><h2 id="modalTitle">ì¹´ë“œ</h2><button class="closeBtn" id="closeBtn">ë‹«ê¸°</button></div>
    <div class="modalBody">
      <div class="modalImg" id="modalImgBox"><img id="modalImg" alt="" /></div>
      <div class="modalText" id="modalText"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast">ë³µì‚¬ë¨!</div>

<script>
const OWNER="moonhong1164", REPO="UniTarot", BRANCH="main";
// GitHub Trees APIëŠ” "ë¸Œëœì¹˜ëª…"ì„ ë°”ë¡œ ë„£ìœ¼ë©´ ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ìš”. ë¨¼ì € ë¸Œëœì¹˜ì˜ tree SHAë¥¼ êµ¬í•œ ë’¤ ì¬ê·€ ìŠ¤ìº”í•©ë‹ˆë‹¤.
async function getTreeSha(){
  const paths=(await githubTreePaths()).filter(p=>extOk(p));
  const cards=paths.map(p=>({title:titleFromPath(p),img:p,folder:folderFromPath(p)}));
  cards.sort((a,b)=>a.title.localeCompare(b.title,"ko"));
  return cards;
}

function renderBoard(){
  const board=$("#board"); board.innerHTML="";
  const sp=SPREADS[state.spreadId], n=sp.count, labels=sp.labels||[];
  for(let i=0;i<n;i++){ 
    const slot=state.drawn[i], label=labels[i]||`ì¹´ë“œ ${i+1}`;
    const el=document.createElement("div");
    el.className="card";
    el.innerHTML=`<div class="cardTop"><div class="badge">${label}</div></div>
      <div class="cardBody">${slot?`<div class="cardFrame"><img src="${slot.img}" alt="${slot.title}" data-path="${slot.img}" style="cursor:pointer"></div>`:`<div class="cardCover">ì…”í”Œ í›„ ì¹´ë“œë¥¼ í™•ì¸í•´ìš”.</div>`}</div>`;
    board.appendChild(el);
  }
    board.querySelectorAll("img[data-path]").forEach(img=>img.addEventListener("click",()=>{const path=img.getAttribute("data-path"); const card=state.cards.find(c=>c.img===path)||{title:titleFromPath(path),img:path,folder:folderFromPath(path)}; openModal(card, true);}));
}

function renderReading(){
  const wrap=$("#reading");
  if(!state.drawn || !state.drawn.length){
    wrap.innerHTML="";
    wrap.classList.add("hidden");
    return;
  }
  wrap.classList.remove("hidden");

  const sp=SPREADS[state.spreadId];
  const labels=sp.labels||[];
  const q=(state.question||"").trim();

  const esc=(s)=>String(s??"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  const stripMeta = (s)=>{
    let txt = String(s);

    if(!s) return "";
        // ğŸ”¢ ìˆ˜ë¹„í•™ì  ì˜ë¯¸ ê°•ì¡°
    txt = txt.replace(/(ìˆ˜ë¹„í•™ì [^\n]*)/g, "ğŸ”¢ $1");
    // ğŸƒ ì¹´ë“œ ìƒì§• ê°•ì¡°
    txt = txt.replace(/(ì•„ë˜ì—ì„œ ì¹˜ê³  ì˜¬ë¼ì˜¤ëŠ”[^\n]*)/g, "ğŸƒ $1");
    return txt
      .split(/\n+/)
      .map(x=>x.trim())
      .filter(x=>x && !x.startsWith("ğŸŒ³") && !/ì•„ë¥´ì¹´ë‚˜/.test(x) && !/^í´ë”\s*Â·/.test(x) && !/(ì½”íŠ¸\s*ì¹´ë“œ|í•\s*ì¹´ë“œ)/.test(x))
      .join("\n")
      .trim();
  };
  const section=(icon,title,txt)=>{
    const t=stripMeta(txt||"");
    if(!t) return "";
    return `<div class="section">
      <div class="ico">${icon}</div>
      <div class="txt"><b>${title}</b><br>${esc(t).replace(/\n+/g,"<br>")}</div>
    </div>`;
  };

  const items = state.drawn.map((slot,i)=>{
    const title = slot?.title || `ì¹´ë“œ ${i+1}`;
    const label = labels[i] || `ì¹´ë“œ ${i+1}`;
    const m = meaningFor(title) || {};
    const kw = (m.keywords||[]).map(x=>String(x||"").trim()).filter(Boolean).join(", ");

    return `
      <div class="readCard">
        <div class="readHead">
          <div class="readPos">${esc(label)}</div>
          <div class="readTitle">${esc(title)}</div>
        </div>
        ${kw?`<div class="readLine"><span class="pill">í‚¤ì›Œë“œ</span> ${esc(kw)}</div>`:""}
        ${section("ğŸ’—","ì• ì •ìš´", m.love)}
        ${section("ğŸ‘¥","ê´€ê³„ìš´", m.relationship)}
        ${section("ğŸ’°","ê¸ˆì „ìš´", m.money)}
        ${section("ğŸ’¼","í•™ì—…/ì§ì—…/ì‚¬ì—…", m.career)}
        ${section("ğŸ§˜","ê±´ê°•ìš´", m.health)}
        ${section("â­","ì¡°ì–¸", m.advice)}
      </div>
    `;
  }).join("");

  wrap.innerHTML = `
    <div class="readTop">
      <div class="readSpread"><b>${esc(sp.name||"ë¦¬ë”©")}</b>${q?`<span class="smallMuted"> Â· ${esc(q)}</span>`:""}</div>
    </div>
    <div class="readGrid">${items}</div>
  `;
}

function doDraw(){ 
  if(!state.cards.length){alert("ì¹´ë“œ ì´ë¯¸ì§€ê°€ ë ˆí¬ì— ì»¤ë°‹ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì¤˜!"); return;}
  const sp=SPREADS[state.spreadId];
  const deck=shuffle(state.cards);
  state.drawn=deck.slice(0,sp.count);
  state.revealed = new Set(Array.from({length: sp.count}, (_,i)=>i));
  renderBoard();
  renderReading();
  $("#reading").classList.remove("hidden");
  updateShareHash(); // ë½‘ìë§ˆì ë§í¬ ìƒì„±
}
function doReset(){ state.drawn=[]; state.revealed=new Set(); renderBoard(); $("#reading").classList.add("hidden"); updateShareHash(true); }

function renderGallery(){
  const list = $("#galleryGrid");
  if(!list) return;
  const q = ($("#qGallery")?.value||"").trim().toLowerCase();
  const cards = getSortedCards().filter(c=>!q || cleanDisplayTitle(c.title).toLowerCase().includes(q));
  list.innerHTML = cards.map(c=>`
    <button class="gCard" data-title="${escAttr(c.title)}" data-img="${escAttr(c.img)}" type="button">
      <div class="gImg"><img src="${c.img}" alt="${c.title}"></div>
      <div class="gTitle">${pad3(c.ord)}. ${cleanDisplayTitle(c.title)}</div>
    </button>
  `).join("");
}

function renderDict(){
  const list = $("#dictList");
  if(!list) return;
  const q = ($("#qDict")?.value||"").trim().toLowerCase();
  const cards = getSortedCards().filter(c=>!q || cleanDisplayTitle(c.title).toLowerCase().includes(q));
  list.innerHTML = cards.map(c=>`
    <button class="dRow" type="button" data-title="${escAttr(c.title)}">
      <div class="dTitle">${pad3(c.ord)}. ${cleanDisplayTitle(c.title)}</div>
    </button>
  `).join("");
}

const LS_KEY="unitarot_saved_readings_v1";

function getSaved(){ 
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]") || []; }catch(e){ return []; }
}
function setSaved(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }

function saveCurrentReading(){
  const sp=SPREADS[state.spreadId];
  if(!state.drawn.length){ alert("ë¨¼ì € ì¹´ë“œë¥¼ ë½‘ì•„ì¤˜!"); return; }
  const item={
    id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random().toString(16).slice(2),
    ts: Date.now(),
    spreadId: state.spreadId,
    question: ($("#question").value||"").trim(),
    drawn: state.drawn.map(c=>({title:c.title, img:c.img, folder:c.folder})),
    revealed: [...state.revealed].sort((a,b)=>a-b)
  };
  const list=getSaved();
  list.unshift(item);
  setSaved(list);
  toast("ì €ì¥ë¨!");
  renderSaved();
}

function removeSaved(id){
  const list=getSaved().filter(x=>x.id!==id);
  setSaved(list);
  renderSaved();
}

function clearSaved(){
  if(!confirm("ì €ì¥í•¨ì„ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
  setSaved([]);
  renderSaved();
}

function renderSaved(){
  const q=norm($("#sq").value);
  const list=getSaved();
  const filtered = q ? list.filter(it=> {
    const bag=[it.question, SPREADS[it.spreadId]?.name, ...(it.drawn||[]).map(d=>d.title)].join(" ");
    return norm(bag).includes(q);
  }) : list;
  $("#scount").textContent=`${filtered.length} / ${list.length} ê°œ`;
  const box=$("#savedList"); box.innerHTML="";
  if(!filtered.length){
    box.innerHTML = `<div class="row"><div class="smallMuted">ì €ì¥ëœ ë¦¬ë”©ì´ ì—†ì–´ìš”. ë½‘ê¸° í™”ë©´ì—ì„œ â€œê²°ê³¼ ì €ì¥â€ì„ ëˆŒëŸ¬ë´!</div></div>`;
    return;
  }
  for(const it of filtered){
    const dt = new Date(it.ts);
    const stamp = dt.toLocaleString("ko-KR");
    const titles = (it.drawn||[]).map(d=>d.title).join(" Â· ");
    const el=document.createElement("div");
    el.className="row";
    el.innerHTML=`
      <div class="rowHead">
        <div>
          <div class="rowTitle">${escapeHtml(SPREADS[it.spreadId]?.name || it.spreadId)} <span class="smallMuted">Â· ${escapeHtml(stamp)}</span></div>
          <div class="smallMuted">${it.question?`Q: ${escapeHtml(it.question)}`:"Q: (ì—†ìŒ)"}</div>
          <div class="smallMuted">${escapeHtml(titles)}</div>
        </div>
        <div class="rowBtns">
          <button class="miniBtn" data-load="${it.id}">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="miniBtn" data-share="${it.id}">ê³µìœ  ë§í¬</button>
          <button class="miniBtn danger" data-del="${it.id}">ì‚­ì œ</button>
        </div>
      </div>
    `;
    box.appendChild(el);
  }
  box.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click",()=>removeSaved(b.getAttribute("data-del"))));
  box.querySelectorAll("[data-load]").forEach(b=>b.addEventListener("click",()=>loadSaved(b.getAttribute("data-load"))));
  box.querySelectorAll("[data-share]").forEach(b=>b.addEventListener("click",()=>shareSaved(b.getAttribute("data-share"))));
}

function loadSaved(id){
  const it = getSaved().find(x=>x.id===id);
  if(!it) return;
  state.spreadId = it.spreadId || "1";
  buildSpreadBar();
  $("#question").value = it.question || "";
  state.drawn = (it.drawn||[]).map(d=>({title:d.title, img:d.img, folder:d.folder}));
  state.revealed = new Set((it.revealed||[]).map(Number));
  renderBoard(); renderReading();
  show("draw");
  updateShareHash();
  toast("ë¶ˆëŸ¬ì˜´!");
}

function shareSaved(id){
  const it = getSaved().find(x=>x.id===id);
  if(!it) return;
  const payload={v:1, spreadId:it.spreadId, question:it.question||"", drawn:(it.drawn||[]).map(d=>d.img), revealed:(it.revealed||[]) };
  copyShareLink(payload);
}

function openDictModal(name){
  const m=INTERPRETATIONS[name];
  $("#modalTitle").textContent=name;
  // ì‚¬ì „ ëª¨ë“œëŠ” ì´ë¯¸ì§€ ìˆ¨ê¹€
  $("#modalImgBox").style.display="none";
  $("#modalText").innerHTML = buildMeaningHtml(name, m, null, true);
  $("#modalBack").classList.add("on");
  $("#modalBack").setAttribute("aria-hidden","false");
}

function openModal(card, showImage){
  $("#modalTitle").textContent=card.title;
  if(showImage){
    $("#modalImgBox").style.display="";
    $("#modalImg").src=card.img;
    $("#modalImg").alt=card.title;
  }else{
    $("#modalImgBox").style.display="none";
  }
  const m=meaningFor(card.title);
  $("#modalText").innerHTML = buildMeaningHtml(card.title, m, card, false);
  $("#modalBack").classList.add("on");
  $("#modalBack").setAttribute("aria-hidden","false");
}

function buildMeaningHtml(title, m, card, dictMode){
  const kws=m?.keywords?.length?m.keywords.join(", "):"";
  const raw=m?.raw?`<details><summary class="smallMuted" style="cursor:pointer;margin-top:8px">PDF ì›ë¬¸ í¼ì¹˜ê¸°</summary><div class="rawBox">${escapeHtml(m.raw)}</div></details>`:"";
  const folderLine = card ? `<p class="kws"><b>í´ë”</b> Â· ${escapeHtml(card.folder)}</p>` : "";
  return `
    ${folderLine}
    ${kws?`<p class="kws"><b>í‚¤ì›Œë“œ</b> Â· ${escapeHtml(kws)}</p>`:""}
    ${m?.love?`<div class="sectionTitle"><b>ì• ì •ìš´</b></div>m.love`:""}
    ${m?.relationship?`<div class="sectionTitle"><b>ê´€ê³„ìš´</b></div>m.relationship`:""}
    ${m?.money?`<div class="sectionTitle"><b>ê¸ˆì „ìš´</b></div>m.money`:""}
    ${m?.career?`<div class="sectionTitle"><b>í•™ì—…/ì§ì—…/ì‚¬ì—…</b></div>m.career`:""}
    ${m?.health?`<div class="sectionTitle"><b>ê±´ê°•ìš´</b></div>m.health`:""}
    ${m?.advice?`<div class="sectionTitle"><b>ì¡°ì–¸</b></div>m.advice`:""}
    ${(!m)?`<p class="smallMuted">í•´ì„ì´ ì—†ì–´ìš”(ì¹´ë“œëª… ë§¤ì¹­ ì‹¤íŒ¨ì¼ ìˆ˜ ìˆìŒ).</p>`:""}
    ${raw}
  `;
}

function escapeHtml(str){return (str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");}
function closeModal(){$("#modalBack").classList.remove("on"); $("#modalBack").setAttribute("aria-hidden","true");}

function show(view){
  const isDraw=view==="draw", isGal=view==="gallery", isDict=view==="dict", isSaved=view==="saved";
  $("#tabDraw").classList.toggle("on",isDraw);
  $("#tabGallery").classList.toggle("on",isGal);
  $("#tabDict").classList.toggle("on",isDict);
  $("#tabSaved").classList.toggle("on",isSaved);

  $("#drawControls").classList.toggle("hidden",!isDraw);
  $("#galleryControls").classList.toggle("hidden",!isGal);
  $("#dictControls").classList.toggle("hidden",!isDict);
  $("#savedControls").classList.toggle("hidden",!isSaved);

  $("#drawView").classList.toggle("hidden",!isDraw);
  $("#galleryView").classList.toggle("hidden",!isGal);
  $("#dictView").classList.toggle("hidden",!isDict);
  $("#savedView").classList.toggle("hidden",!isSaved);

  if(isGal) renderGallery();
  if(isDict) renderDict();
  if(isSaved) renderSaved();
}

function encodeState(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function decodeState(b64url){
  const b64 = b64url.replace(/-/g,"+").replace(/_/g,"/");
  const pad = b64.length % 4 ? "=".repeat(4-(b64.length%4)) : "";
  const json = decodeURIComponent(escape(atob(b64+pad)));
  return JSON.parse(json);
}

function currentSharePayload(){
  return {
    v:1,
    spreadId: state.spreadId,
    question: ($("#question").value||"").trim(),
    drawn: (state.drawn||[]).map(c=>c.img),
    revealed: [...state.revealed].sort((a,b)=>a-b)
  };
}

function updateShareHash(clear=false){
  if(clear || !state.drawn.length) {
    history.replaceState(null,"", location.pathname + location.search);
    return;
  }
  const payload=currentSharePayload();
  const token=encodeState(payload);
  history.replaceState(null,"", location.pathname + location.search + "#s=" + token);
}

async function copyText(text){
  try {
    await navigator.clipboard.writeText(text);
    toast("ë³µì‚¬ë¨!");
  } catch (e) {
    // fallback
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    ta.remove();
    toast("ë³µì‚¬ë¨!");
  }
}

function copyShareLink(payload){
  const token=encodeState(payload);
  const url = location.origin + location.pathname + location.search + "#s=" + token;
  copyText(url);
}

function shareCurrent(){
  if(!state.drawn.length){ alert("ë¨¼ì € ì¹´ë“œë¥¼ ë½‘ì•„ì¤˜!"); return; }
  copyShareLink(currentSharePayload());
}

let pendingSharedState = null;

function applySharedState(shared){
  if(!shared || !shared.drawn) return;
  state.spreadId = shared.spreadId || "1";
  buildSpreadBar();
  $("#question").value = shared.question || "";
  // cards load ì´í›„ ë§¤í•‘ í•„ìš”
  const wanted = shared.drawn.slice();
  state.drawn = wanted.map(path=> {
    const c = state.cards.find(x=>x.img===path);
    return c || {title:titleFromPath(path), img:path, folder:folderFromPath(path)};
  });
  state.revealed = new Set((shared.revealed||[]).map(Number));
  renderBoard(); renderReading();
  show("draw");
}

(function readHash(){
  const m = location.hash.match(/#s=([A-Za-z0-9_\-]+)/);
  if(!m) return;
  try {
    pendingSharedState = decodeState(m[1]);
  } catch(e) {
    console.log("bad share state", e);
  }
})();

(async function init(){
  try{
    buildSpreadBar();
    setStatus("ì´ë¯¸ì§€ ìŠ¤ìº” ì¤‘â€¦ (ë ˆí¬ ì•ˆ ì–´ë””ì— ì˜¬ë ¤ë„ ìë™ ì—°ê²°)");
    state.cards = await loadCardsFromGithub();
    setStatus(`ì¤€ë¹„ ì™„ë£Œ Â· ì¹´ë“œ ${state.cards.length}ì¥ Â· ì‚¬ì „/ì €ì¥/ê³µìœ  í¬í•¨`);

    $("#drawBtn").addEventListener("click", doDraw);
    $("#resetBtn").addEventListener("click", ()=>{$("#question").value=""; doReset();});
    $("#shareBtn").addEventListener("click", shareCurrent);
    $("#saveBtn").addEventListener("click", saveCurrentReading);
    $("#question").addEventListener("input", ()=>updateShareHash());

    ["q","folderSearch"].forEach(id=>$("#"+id).addEventListener("input", renderGallery));
    ["dq","dkw"].forEach(id=>$("#"+id).addEventListener("input", renderDict));
    $("#sq").addEventListener("input", renderSaved);
    $("#clearSavedBtn").addEventListener("click", clearSaved);

    $("#tabDraw").addEventListener("click", ()=>show("draw"));
    $("#tabGallery").addEventListener("click", ()=>show("gallery"));
    $("#tabDict").addEventListener("click", ()=>show("dict"));
    $("#tabSaved").addEventListener("click", ()=>show("saved"));

    $("#closeBtn").addEventListener("click", closeModal);
    $("#modalBack").addEventListener("click",(e)=>{if(e.target.id==="modalBack") closeModal();});
    window.addEventListener("keydown",(e)=>{if(e.key==="Escape") closeModal();});

    renderBoard(); $("#reading").classList.add("hidden"); show("draw");

    if(pendingSharedState) applySharedState(pendingSharedState);

  }catch(e){ console.error(e); setStatus("ë¡œë“œ ì‹¤íŒ¨: "+String(e)); $("#galleryGrid").innerHTML = `<div class="hint">ì´ë¯¸ì§€ ëª©ë¡ì„ ëª» ë¶ˆëŸ¬ì™”ì–´ìš”. (GitHub API ì œí•œ/ì˜¤ë¥˜)
ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>`; $("#dictList").innerHTML = `<div class="hint">ì´ë¯¸ì§€ ëª©ë¡ì„ ëª» ë¶ˆëŸ¬ì™”ì–´ìš”.</div>`; }
})();
</script>
</body></html>
